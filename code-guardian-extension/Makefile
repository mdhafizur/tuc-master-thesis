# Code Guardian - VS Code Extension Makefile
# Simplifies common development, testing, and deployment tasks

# Personal Access Token for publishing (set via: export VSCE_PAT=your_token)
# Or create a .vsce-pat file with your token
VSCE_PAT ?= $(shell cat .vsce-pat 2>/dev/null || echo "")

.PHONY: help install compile test package publish publish-patch publish-minor publish-major clean dev lint format check-deps login set-pat release-patch release-minor release-major

# Default target - show help
help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘          Code Guardian - VS Code Extension                â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Available targets:"
	@echo ""
	@echo "  Development:"
	@echo "    make install       - Install all dependencies"
	@echo "    make dev          - Start development mode with watch"
	@echo "    make compile      - Compile extension"
	@echo "    make lint         - Run ESLint"
	@echo "    make lint-fix     - Run ESLint with auto-fix"
	@echo "    make format       - Format code (if configured)"
	@echo ""
	@echo "  Testing:"
	@echo "    make test         - Run all tests"
	@echo "    make test-unit    - Run unit tests only"
	@echo "    make test-data    - Test vulnerability data sources"
	@echo "    make coverage     - Run tests with coverage"
	@echo "    make coverage-view - View coverage report"
	@echo "    make evaluate     - Evaluate model accuracy"
	@echo "    make benchmark    - Run performance benchmarks"
	@echo ""
	@echo "  Deployment (Local):"
	@echo "    make package        - Package extension as VSIX"
	@echo "    make publish        - Publish to VS Code Marketplace (requires PAT)"
	@echo "    make publish-patch  - Bump patch version and publish locally"
	@echo "    make publish-minor  - Bump minor version and publish locally"
	@echo "    make publish-major  - Bump major version and publish locally"
	@echo ""
	@echo "  Deployment (GitHub Actions):"
	@echo "    make release-patch  - Bump patch, tag, push â†’ GitHub Actions publish"
	@echo "    make release-minor  - Bump minor, tag, push â†’ GitHub Actions publish"
	@echo "    make release-major  - Bump major, tag, push â†’ GitHub Actions publish"
	@echo ""
	@echo "  Authentication:"
	@echo "    make login          - Login to VS Code Marketplace"
	@echo "    make set-pat        - Create .vsce-pat file for authentication"
	@echo ""
	@echo "  Utilities:"
	@echo "    make clean        - Clean build artifacts"
	@echo "    make check-deps   - Check for outdated dependencies"
	@echo "    make audit        - Run npm security audit"
	@echo "    make audit-fix    - Fix npm security issues"
	@echo "    make install-vsce - Install VSCE packaging tool"
	@echo ""

# Install all dependencies
install:
	@echo "ğŸ“¦ Installing dependencies..."
	npm install

# Install VSCE if not already installed
install-vsce:
	@echo "ğŸ“¦ Installing VSCE (VS Code Extension packaging tool)..."
	npm install -g @vscode/vsce

# Compile the extension
compile:
	@echo "ğŸ”¨ Compiling extension..."
	npm run compile

# Start development mode with watch
dev:
	@echo "ğŸ‘€ Starting development mode with watch..."
	@echo "Press F5 in VS Code to launch Extension Development Host"
	npm run watch

# Run linter
lint:
	@echo "ğŸ” Running ESLint..."
	npm run lint

# Run linter with auto-fix
lint-fix:
	@echo "ğŸ”§ Running ESLint with auto-fix..."
	npm run lint:fix

# Format code (placeholder - add prettier if needed)
format:
	@echo "âœ¨ Formatting code..."
	@echo "Note: Add prettier to package.json for automatic formatting"

# Run all tests
test:
	@echo "ğŸ§ª Running all tests..."
	npm test

# Run unit tests only
test-unit:
	@echo "ğŸ§ª Running unit tests..."
	npm run test:unit

# Test vulnerability data sources
test-data:
	@echo "ğŸ”’ Testing vulnerability data sources..."
	npm run test:data-sources

# Run tests with coverage
coverage:
	@echo "ğŸ“Š Running tests with coverage..."
	npm run test:coverage

# View coverage report
coverage-view:
	@echo "ğŸ“Š Opening coverage report..."
	npm run coverage:view

# Evaluate model accuracy
evaluate:
	@echo "ğŸ¯ Evaluating model accuracy..."
	npm run evaluate

# Run performance benchmarks
benchmark:
	@echo "âš¡ Running performance benchmarks..."
	npm run benchmark

# Package extension as VSIX
package: clean compile test
	@echo "ğŸ“¦ Packaging extension..."
	vsce package --no-dependencies
	@echo ""
	@echo "âœ… Package created successfully!"
	@ls -lh *.vsix

# Login to VS Code Marketplace
login:
	@echo "ğŸ” Logging in to VS Code Marketplace..."
	@if [ -n "$(VSCE_PAT)" ]; then \
		echo "$(VSCE_PAT)" | vsce login DreamersRedemption; \
		echo "âœ… Login successful!"; \
	else \
		echo "âŒ No PAT found. Set VSCE_PAT in Makefile or environment variable"; \
		echo "   Get your PAT from: https://aka.ms/vscodepat"; \
		exit 1; \
	fi

# Publish to VS Code Marketplace
publish: package
	@echo "ğŸš€ Publishing to VS Code Marketplace..."
	@if [ -n "$(VSCE_PAT)" ]; then \
		vsce publish --no-dependencies --pat "$(VSCE_PAT)"; \
		echo "âœ… Published successfully!"; \
	else \
		echo "âŒ No PAT found. Set VSCE_PAT in Makefile"; \
		exit 1; \
	fi

# Publish with patch version bump (1.0.6 -> 1.0.7)
publish-patch: clean compile test
	@echo "ğŸš€ Publishing patch version..."
	@if [ -n "$(VSCE_PAT)" ]; then \
		vsce publish patch --no-dependencies --pat "$(VSCE_PAT)"; \
		echo "âœ… Patch version published successfully!"; \
	else \
		echo "âŒ No PAT found. Set VSCE_PAT in Makefile"; \
		exit 1; \
	fi

# Publish with minor version bump (1.0.6 -> 1.1.0)
publish-minor: clean compile test
	@echo "ğŸš€ Publishing minor version..."
	@if [ -n "$(VSCE_PAT)" ]; then \
		vsce publish minor --no-dependencies --pat "$(VSCE_PAT)"; \
		echo "âœ… Minor version published successfully!"; \
	else \
		echo "âŒ No PAT found. Set VSCE_PAT in Makefile"; \
		exit 1; \
	fi

# Publish with major version bump (1.0.6 -> 2.0.0)
publish-major: clean compile test
	@echo "ğŸš€ Publishing major version..."
	@if [ -n "$(VSCE_PAT)" ]; then \
		vsce publish major --no-dependencies --pat "$(VSCE_PAT)"; \
		echo "âœ… Major version published successfully!"; \
	else \
		echo "âŒ No PAT found. Set VSCE_PAT in Makefile"; \
		exit 1; \
	fi

# Create .vsce-pat file for storing PAT
set-pat:
	@echo "ğŸ”‘ Setting up Personal Access Token..."
	@echo "âš ï¸  This will create/overwrite .vsce-pat file"
	@echo "Please paste your Azure DevOps PAT and press Enter:"
	@read -s pat; \
	echo "$$pat" > .vsce-pat && \
	chmod 600 .vsce-pat && \
	echo "âœ… PAT saved to .vsce-pat" && \
	echo "âš ï¸  Make sure .vsce-pat is in your .gitignore!" || \
	(echo "âŒ Failed to save PAT"; exit 1)

# ============================================================
# GitHub Actions Release Targets
# ============================================================

# Release patch version via GitHub Actions (1.0.6 -> 1.0.7)
release-patch: clean compile test
	@echo "ğŸš€ Preparing patch release via GitHub Actions..."
	@echo ""
	@echo "ğŸ“‹ Pre-flight checks:"
	@git diff-index --quiet HEAD || (echo "âŒ Uncommitted changes detected. Commit or stash them first." && exit 1)
	@echo "âœ… No uncommitted changes"
	@git remote get-url origin > /dev/null 2>&1 || (echo "âŒ No git remote configured" && exit 1)
	@echo "âœ… Git remote configured"
	@echo ""
	@echo "ğŸ“¦ Bumping patch version..."
	npm version patch -m "chore: bump version to %s"
	@NEW_VERSION=$$(node -p "require('./package.json').version"); \
	echo ""; \
	echo "âœ… Version bumped to $$NEW_VERSION"; \
	echo ""; \
	echo "ğŸ·ï¸  Pushing changes and tags to GitHub..."; \
	git push && git push --tags; \
	echo ""; \
	echo "âœ… Release initiated!"; \
	echo ""; \
	echo "ğŸ“Š GitHub Actions will now:"; \
	echo "   1. Run tests"; \
	echo "   2. Build extension"; \
	echo "   3. Publish to VS Code Marketplace"; \
	echo "   4. Create GitHub Release"; \
	echo ""; \
	echo "ğŸ”— View workflow: https://github.com/$$(git remote get-url origin | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/actions"

# Release minor version via GitHub Actions (1.0.6 -> 1.1.0)
release-minor: clean compile test
	@echo "ğŸš€ Preparing minor release via GitHub Actions..."
	@echo ""
	@echo "ğŸ“‹ Pre-flight checks:"
	@git diff-index --quiet HEAD || (echo "âŒ Uncommitted changes detected. Commit or stash them first." && exit 1)
	@echo "âœ… No uncommitted changes"
	@git remote get-url origin > /dev/null 2>&1 || (echo "âŒ No git remote configured" && exit 1)
	@echo "âœ… Git remote configured"
	@echo ""
	@echo "ğŸ“¦ Bumping minor version..."
	npm version minor -m "chore: bump version to %s"
	@NEW_VERSION=$$(node -p "require('./package.json').version"); \
	echo ""; \
	echo "âœ… Version bumped to $$NEW_VERSION"; \
	echo ""; \
	echo "ğŸ·ï¸  Pushing changes and tags to GitHub..."; \
	git push && git push --tags; \
	echo ""; \
	echo "âœ… Release initiated!"; \
	echo ""; \
	echo "ğŸ“Š GitHub Actions will now:"; \
	echo "   1. Run tests"; \
	echo "   2. Build extension"; \
	echo "   3. Publish to VS Code Marketplace"; \
	echo "   4. Create GitHub Release"; \
	echo ""; \
	echo "ğŸ”— View workflow: https://github.com/$$(git remote get-url origin | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/actions"

# Release major version via GitHub Actions (1.0.6 -> 2.0.0)
release-major: clean compile test
	@echo "ğŸš€ Preparing major release via GitHub Actions..."
	@echo ""
	@echo "âš ï¸  WARNING: This will bump the MAJOR version!"
	@echo "   This indicates breaking changes."
	@echo ""
	@read -p "Are you sure? (yes/no): " confirm; \
	if [ "$$confirm" != "yes" ]; then \
		echo "âŒ Release cancelled"; \
		exit 1; \
	fi
	@echo ""
	@echo "ğŸ“‹ Pre-flight checks:"
	@git diff-index --quiet HEAD || (echo "âŒ Uncommitted changes detected. Commit or stash them first." && exit 1)
	@echo "âœ… No uncommitted changes"
	@git remote get-url origin > /dev/null 2>&1 || (echo "âŒ No git remote configured" && exit 1)
	@echo "âœ… Git remote configured"
	@echo ""
	@echo "ğŸ“¦ Bumping major version..."
	npm version major -m "chore: bump version to %s"
	@NEW_VERSION=$$(node -p "require('./package.json').version"); \
	echo ""; \
	echo "âœ… Version bumped to $$NEW_VERSION"; \
	echo ""; \
	echo "ğŸ·ï¸  Pushing changes and tags to GitHub..."; \
	git push && git push --tags; \
	echo ""; \
	echo "âœ… Release initiated!"; \
	echo ""; \
	echo "ğŸ“Š GitHub Actions will now:"; \
	echo "   1. Run tests"; \
	echo "   2. Build extension"; \
	echo "   3. Publish to VS Code Marketplace"; \
	echo "   4. Create GitHub Release"; \
	echo ""; \
	echo "ğŸ”— View workflow: https://github.com/$$(git remote get-url origin | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/actions"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf dist/
	rm -rf out/
	rm -rf coverage/
	rm -rf .vscode-test/
	rm -f *.vsix
	@echo "âœ… Clean complete!"

# Check for outdated dependencies
check-deps:
	@echo "ğŸ” Checking for outdated dependencies..."
	npm outdated

# Run npm security audit
audit:
	@echo "ğŸ”’ Running npm security audit..."
	npm audit

# Fix npm security issues
audit-fix:
	@echo "ğŸ”§ Fixing npm security issues..."
	npm audit fix

# Pre-commit hook (run before committing)
pre-commit: lint test
	@echo "âœ… Pre-commit checks passed!"

# CI/CD target - run all checks
ci: install compile lint test package
	@echo "âœ… CI checks passed!"

# Quick development iteration
quick: compile
	@echo "âš¡ Quick compile done! Press F5 to test."

# Full build and test cycle
build: clean install compile test package
	@echo "âœ… Full build complete!"
